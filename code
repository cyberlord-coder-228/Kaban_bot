'use strict';

const { Telegraf } = require('telegraf');
const {google} = require('googleapis');
const {stripHtml}= require("string-strip-html");
const fetch = require('node-fetch');

const bot = new Telegraf('1642862707:AAAAAAAAAAAAAAAAAAAAAAAAAAAAA');
//const gApi = new GoogleAPI(process.env.google);


bot.start(ctx => ctx.reply('/*start_phrase*/'));

bot.command('elephant', ctx => {
  const input = ctx.message.text.split(' ').slice(1).join(' ');
  //ctx.reply('Всі кажуть ' + input + ', а ти купи /*something*/');

  if (!input && ctx.message.reply_to_message) {
    ctx.reply(`Всі кажуть ${ctx.message.reply_to_message.text}, а ти купи /*something*/`);
  } else if (!input) {
    ctx.reply('Для того, щоб зіграти в слона необхідно написати текст після команди /elephant, або відповісти на будь-яке повідомлення цього бота відповідним текстом.');
  } else {
    ctx.reply(`Всі кажуть ${input}, а ти купи /*something*/`);
  }
});

let isFirstJokeCall = true;
bot.command('joke', ctx => {
  if (isFirstTime) {
    ctx.reply('Хочу вибачитись наперед');
    return isFirstJokeCall = false;
  }
  if (Math.random() < 0.8) {
	const SubjectsArr = [...]; // тут всі можливі підмети

	const ActionsArr = [...]; // тут всі можливі присудки

    ctx.reply(SubjectsArr[Math.floor(Math.random() * SubjectsArr.length)] +
        ' ' +  ActionsArr[Math.floor(Math.random() * ActionsArr.length)] +
        ((Math.random() < 0.1) ? '/*your phrase*/' : '')
    ); //результат - просте речення типу "колобок втопився", яке може бути чи не бути смішним, залежно від ступеню хворобливості вашого почуття гумору
  } else {
    const PunsArr = [...]; // тут всі можливі dad-jockes++
    ctx.reply(PunsArr[Math.floor(Math.random() * PunsArr.length)]); //результат - один з наперед заготованих панчлайнів
  }
});

bot.command('pidor', ctx => {
  ctx.reply('Сам такий!');
}); //а як зробити так, щоб бот саме реплаїв, а не просто писав щось у чат?

bot.command('zhevyi', async ctx => {
  const sleep = ms => new Promise (resolve => setTimeout(resolve, ms));

  ctx.reply('Йа же-ВИЙ!');
  await sleep(1000);
  ctx.reply('Йа віль-НИЙ!');
  await sleep(1000);
  ctx.reply('Йамотіватор!');
});

/*bot.command('g', async ctx => {
  const input = ctx.message.text.split(' ').slice(1).join(' ');
  console.log(input);

  async function wa(request) {
    try {
      const result = await gApi.getShort(request);
      await ctx.reply(result);
    } catch (err) {
      if (err.message.includes('Коротка відповідь недоступна')) {
        try {
          await ctx.reply('Кидаю фотку');
          const result = await gApi.getSimple(request); // URI (with suffix)
          const base64 = result.toString().replace(/^.{22}/, '');
          await ctx.replyWithPhoto({ source: Buffer.from(base64, 'base64') });
        } catch (err) {
          await ctx.reply(err.message);
        }
      } else await ctx.reply(err.message);
    }
  }
});*/ //команда в процесі розробки. хто знає як брати результати пошуку з гуглу - help

bot.command('rand', ctx => {
  const input = ctx.message.text.split(' ').slice(1).join(' ');

  if (!isNaN(parseInt(input, 10))) ctx.reply(Math.random() * parseInt(input, 10));
  else ctx.reply(Math.random());
});

bot.command('wiki', async ctx => { /*by nocommas555, mutated by ne_vlad_ip_04*/
  const input = ctx.message.text.split(' ').slice(1).join(' ');

  if (input && /[a-z]/i.test(input)) try {
    async function wiki_search(){
    //const q = 'node.js'
    let response = await fetch('https://en.wikipedia.org/w/api.php?action=query&list=search&prop=info&inprop=url&utf8=&format=json&srlimit=5&srsearch='+input)
    response = await response.json()

    for (const res of response["query"]["search"])
    {
      let ret = stripHtml(res["snippet"]).result+"\n"
      //if (!res["snippet"].toLowerCase().includes(res["title"].toLowerCase()))
        ret = res['title'] + " - " + ret 

      ctx.reply(ret);
    }
    }
    try {wiki_search() } catch (e) { console.log(e.message); };
  } catch (e) { console.log(e.message); };
}); //видає рандомну частину визначення зі статті, що містить input. нащо - хз, але прикольно

bot.command('e', async ctx => {
  let input = ctx.message.text.substring(3);

if (ctx.message.reply_to_message && ctx.message.reply_to_message.text) {
  	if ((!input && ctx.message.reply_to_message.text.includes('='))
  	     || input === 'precisely') 
  	  input = ctx.message.reply_to_message.text;
  	else if (isNaN(ctx.message.reply_to_message.text) 
  		      && !ctx.message.reply_to_message.text.includes('=')) 
  	  input = '("' + ctx.message.reply_to_message.text + '")' + input;
  	else if (ctx.message.reply_to_message.text.includes('='))
  	  input = '(' + ctx.message.reply_to_message.text + ')' + input;
    else input = '(' + ctx.message.reply_to_message.text + ')' + input;
  }
  if (!input) ctx.reply('Так а вхідні дані не задано :/');
  let result;

  console.log('input: ' + input);
  //console.log(ctx.chat.id);
  console.log('from.username: ' + ctx.message.from.username);
  console.log('Name: ' + ctx.message.from.first_name, ctx.message.from.last_name);

  try {
  	if (!input.includes('process') && !input.includes('require') 
  		&& !input.includes('exit') && !input.includes('import') && !input.includes('/*')
  		&& !input.includes('*/') && !input.includes('eval') && !input.includes('for') 
  		&& !input.includes('ctx') && !input.includes('while') && !input.includes('request') 
  		&& !input.includes('Array') && !input.includes('repeat') && !input.includes('open')
  		&& !input.includes('close') && !input.includes('this') && !input.includes('JSON')
  		&& !input.includes('bot') && !input.includes('ping')) {result = eval(input);}
  	else ctx.reply('It\'s forbidden');
  	if (result !== undefined) ctx.reply(result);
  } catch (e) { console.log(e.message); };

  console.log(' ');
}); //виконує заданий код (якщо він не містить нічого потенційно шкідливого) і відсилає повідомлення результату

bot.command('giveinfo', async ctx => {
  const input = ctx.message.text.split(' ').slice(1).join(' ');

  console.log('input: ' + input);
  console.log('Chat_ID: ' + ctx.chat.id);
  console.log('User_ID: ' + ctx.message.from.id);
  console.log('from.username: ' + ctx.message.from.username);
  console.log('Name: ' + ctx.message.from.first_name, ctx.message.from.last_name);
  console.log(' ');
}); //just for testing

bot.hears('слон', ctx => ctx.reply('А го зіграєм'));

bot.on('message', ctx => {
  try {
    if (ctx.message.reply_to_message && ctx.message.reply_to_message.from.id === 1642862707) {
      if (Math.random() < 0.1 && !ctx.message.reply_to_message.text.includes('/о')) {
      	ctx.reply(`Всі кажуть ${ctx.message.text}, а ти купи гараж`);
      }
    }
  } catch (e) { console.log(e.message); }
});

bot.launch().then(() => console.log('Bot has successfully started!'));
